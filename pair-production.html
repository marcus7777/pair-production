<link rel="import" href="../iron-accordions/iron-accordions.html"> 
<link rel="import" href="../prism-element/prism-highlighter.html">
<link rel="import" href="../marked-element/marked-element.html">
<link rel="import" href="../toggle-icon/toggle-icon.html">
<link rel="import" href="../icon-icons/iron-icons.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../url-data/url-data.html">
<link rel="import" href="../iron-location/iron-location.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<link rel="import" href="../paper-input/paper-input.html">

<link rel="import" href="function-list-input.html">
<link rel="import" href="input-save.html">
<link rel="import" href="variables-input.html">
<link rel="import" href="load-element-list.html">
<!--
 `<pair-production>` I'm hoping this will be a good way to think about the way your code a element and then give you:
 * Template editor ✔
  
 * auto add dependencies (if in open-elements.org or in 'localstorage'). ✔
  
 * Markdown editor for documentation ✔
 
 * a working demo ✔
 
 * a test ✏'for each input and output
 * test ```location```
   * input ```location```: london
  
   * output ```hash``` = gcpvj0dup40s
    
  * test ```hash```
    * input ```location```: tr18
    
    * output ```hash``` = gbuj1g4pw5b4
    
 * a bower.json file ✏/ bower command
 
demo at [data](https://open-elements.org/bower_components/pair-production/demo.html) need to fixed

All help is very much appreciated. I hope this project helps people get started with polymer. And it is also a big thank you to the polymer team for all the help.
@demo demo.html run it 
@hero hero.svg
-->
<dom-module id="pair-production">
  <template>
    <div class="vertical center-justified layout">
      <template is="dom-if" if="{{!elementData.name}}">
        <h2>Let me help you conjure a new element:</h2>
      </template>
      <iron-accordions>
        <iron-accordion opened="{{does}}">
          <h3 header>What does it do?</h3>
          <input-save path="description" markdown textarea value="{{elementData.description}}" label="About it (markdown)"></input-save>
        </iron-accordion>
        <iron-accordion opened="{{unnamed}}">
          <h3 header>Name</toggle-icon></h3>
          <input-save path="name" label="Name the new element - like pirate-ninja" invalid="{{invalidName}}" value="{{elementData.name}}" pattern="[a-z0-9]+-[a-z0-9\-]*[a-z0-9]+" auto-validate  error-message="Need's to have a '-' between lowercase letters "></input-save>
          <template is="dom-if" if="{{_gotName}}">
            <p>this is in the open-elements catalog I'm working on loading it for you (not today)</p> 
          </template>
          <load-elements-list data="{{localData}}" to="{{elementData}}"></load-elements-list>
        </iron-accordion>
        <template is="dom-if" if="{{elementData.name}}">
          <template is="dom-if" if="{{!invalidName}}">	
            <iron-accordion opened>
              <h3 header>The HTML</h3>
              <template is="dom-if" if="{{_dependencylist.length}}">
                <select style="float:right" value="{{docsFor::input}}">
                  <option value="">show documentation</option>
                  <template is="dom-repeat" items="{{_dependencylist}}" >
                    <option>{{item}}</option>
                  </template>
                </select>
                <template is="dom-if" if="{{docsFor}}" >
                  <iframe sandbox="allow-scripts allow-same-origin" height="300" style="margin:0; width:100%; border:none;" src="{{_docsSrc(docsFor, _listOfElements)}}"></iframe>
                </template>
              </template>
              <input-save path="template" code textarea with-attr-option value="{{elementData.html}}" list-of-elements="{{_listOfElements}}" label$="html of <{{elementData.name}} />"></input-save>
                
              <paper-input label="attr1='value1' attr2='value2'  attr3='value3' " value="{{elementData.attrsForDemo}}">
                <div prefix>&lt;{{elementData.name}} &nbsp; </div>
                <div suffix> &gt;&lt;/{{elementData.name}}&gt;</div>
              </paper-input>
              <iframe sandbox="allow-scripts allow-same-origin" height="{{demoHeight}}" style="margin:0;width:100%;border:none;" srcdoc="{{_src}}"></iframe>
            </iron-accordion>
            <iron-accordion>
              <h3 header title="Variables/Attributes/Properties">Properties</h3>
              <variables-input functions="{{elementData.functions}}" value="{{elementData.properties}}" name="{{elementData.name}}"></variables-input>   
            </iron-accordion>
            <iron-accordion>
              <h3 header title="Functions/Methods">Methods</h3>
              <input-save path="functions" code label="Give me list of functions it will need" value="{{elementData.functions}}" pattern="[a-z0-9A-Z0-9]*[a-z0-9A-Z0-9\,]*[a-z0-9A-Z0-9]+" auto-validate  error-message="sorry a ',' separated list "></input-save>
              <template is="dom-repeat" items="{{_functionList}}" >
                <function-list-input variable-list="{{_variableList}}" name="{{item}}" value="{{elementData.functions}}"></function-list-input>   
              </template>
            </iron-accordion>
            <iron-accordion>
              <h3 header>Share Your element</h3>
              Link to Share <a href="{{link}}">link to {{elementData.name}}</a> <br />
              <prism-highlighter></prism-highlighter>
              <marked-element markdown="{{_markdown}}"></marked-element>
              your Docs are going here:<br />
              <a href="https://github.com/new">new</a>
              your other localy save elements are going to be available for your demo and listed here:
              <input-save textarea path="moreHTML" value="{{_moreHTML}}"></input-save>
            </iron-accordion>
            <iron-accordion>
              <h3 header>Settings</h3>
              <input-save path="demoHeight" type="number" value="{{demoHeight}}" label="Height of demo" ></input-save>
              <input-save path="dependencies" code label="what are the elements will your element need" value="{{_dependencies}}" pattern="[a-z0-9A-Z0-9\/-]*[a-z0-9A-Z0-9\/\,-]*[a-z0-9A-Z0-9\/-]+" auto-validate  error-message="sorry a ',' separated list "></input-save>
              <input-save label="base url" pattern="^(?:https?://)?(?:[\w]+\.)(?:\.?[\w]{2,})+$" path="base" value="{{_base}}"></input-save>
            </iron-accordion>
          </template>
        </template>
      </iron-accordions>
    </div>
    <iron-ajax auto url="/list-of-elements" handle-as="text" last-response="{{_listOfElements}}"></iron-ajax>
    <iron-ajax auto url="/gitList" handle-as="text" last-response="{{_gitList}}"></iron-ajax>
    
    <template is="dom-if" if="{{!elementData.name}}">
      <iron-location hash="{{stringifyData}}"></iron-location>    
      <url-data string="{{stringifyData}}" data-from-string="{{elementData}}"></url-data>
    </template>

    <iron-localstorage on-iron-localstorage-load-empty="initializeDefaultlocal" name="saved-elements" value="{{localData}}"></iron-localstorage>
    
    <template is="dom-if" if="{{elementData.name}}" restamp>
      <url-data string-from-data="{{stringFromElementData}}" compress debounce-data="{{elementData}}"></url-data>
    </template>
  </template>
</dom-module>
<script>
;(function () {
  // var dataVectors = ["url","localData","user"]
  
  var at = 0
  var tabs = function (n) {
    var output = ''
    if (+n < 0) { at += n }
    for (var i = 0; i < at; ++i) {
      output += '  '
    }
    if (+n > 0) { at += n }
    return output
  }
  var addLine = function (nl) {
    return nl.join('\n')
  }
  var toCamelCase = function (str) {
    if (typeof str === 'string') {
      return str.replace(/ {2}|-|_/g, ' ').replace(/, /g, ',').replace(/ \S/g, function (txt) {
        return txt.toUpperCase()[1]
      })
    } else {
      return false
    }
  }
  function merge (obj1,obj2){
    var obj3 = {}
    for (var attrname in obj1) { obj3[attrname] = obj1[attrname] }
    for (var attrname in obj2) { obj3[attrname] = obj2[attrname] }
    return obj3
  }
  function funcIt (functs) {
    var functObj = {akey:"aval"}
    console.log(functs)
    return functObj
  }
  var getfile = function (dependency, listOfElements) {
    var re = /bower_components/gi
    var elements = listOfElements.split('\n')
    for (var i = 0; i < elements.length; ++i) {
      if (elements[i].indexOf('/' + dependency + '.html') !== -1) {
        return listOfElements.split('\n')[i].replace(re, '..')
      }
    }
    return '../polymer/polymer.html'
  }
  var getfileForIframe = function (dependency, listOfElements) {
    var re = /bower_components/gi
    var elements = listOfElements.split('\n')
    for (var i = 0; i < elements.length; ++i) {
      if (elements[i].indexOf('/' + dependency + '.html') !== -1) {
        return '/'+listOfElements.split('\n')[i].replace(re, '..')
      }
    }
    return '../polymer/polymer.html'
  }
  Polymer({
    is: 'pair-production',
    properties: {
      _gotName:{computed: 'getGotName(elementData.name, _listOfElements)'},
      _variablesSets: {type: String, value: 'Inputs,Outputs,Internal'},
      _base: {type: String, value: '/bower_components/new/'},
      _functionList: {computed: '_getArray(elementData.functions)'},
      _dependencies: {type: String, value: 'polymer'},
      _domTemplateDependencies: {computed: '_getDomTemplateDependencies(elementData.html,_dependencies)'},
      _dependencylist: {computed: '_getArray(_dependencies, _domTemplateDependencies)'},
      _demo: {computed: '_getCode(_head,_body)'},
      _iframeDemo: {computed: '_getCode(_iframeHead,_body)'},
      _head: {computed: '_getHead(elementData.name)'},
      _iframeHead: {computed: '_getIframeHead(_base,elementData.name)'},
      _body: {computed: '_getBody(elementData.name, elementData.attrsForDemo)'},
      _listOfElements:String,
      _listOfElementsList:{computed: '_getArray()'},
      _element:{computed:'_getElementCode(elementData,_dependencylist,_listOfElements,elementData.*)'},
      _descriptor: {computed: '_getDescriptor(_element)'},
      _tests: {computed: '_getTests(elementData.name)'},
      _markdown: {computed: '_getMarkdown(_demo,_element,elementData.name,_bower,_tests)'},
      _codeiframe: {computed: '_getCodeiframe(_iframeDemo,_element)'},
      _bower: {computed: '_getBower(elementData.name, elementData.description, _dependencylist, _listOfElements, _gitList)'},
      _src: {computed: '_getSrc(_codeiframe)'},
      demoHeight: {value: 400},
      runMakeLocalData: {computed:"makeLocalData(elementData.name, elementData, localData, elementData.properties.*)"},
      changed: {type: Boolean, notify: true, value: false},
      link: {computed:"getLink(stringFromElementData)"},
      elementData: {
        value: {
          html: '<style>:host {display:inline-block;}</style>\n<h2>Demo</h2>', 
        }
      },
      settingsData: {value: {}}
    },
    getLink: function(link) {
      return '#' + link
    },
    makeLocalData: function (name, data, localData) {
      if (localData && localData.hasOwnProperty(name)) {
        if (JSON.stringify(localData[name]) !== JSON.stringify(data) ) {
          this.set("localData." + name, data)
        }       
      } else if (localData) {
        this.set("localData." + name, data)
      }
      return // TODO debounce and check for versions
    },
    initializeDefaultlocal: function () {
      this.set('localData', {})
    }, 
    getGotName: function (name, list) {
      if (-1 !== list.indexOf('bower_components/'+name+'/'+name+'.html')) {
        document.title = "Rewriting " + name
        return true
      } else {
        document.title = "Making " + name
        return false
      }
    },
    _getBower: function (name, description, dependencylist, listOfElements, gitList) { // TODO fix for paper-textarea ...
      var output = {
        name:  name,
        version: "1.0.0",
        description: description,
        main: name + '.html',
        keywords: ["polymer","web-components"],
        dependencies: {}
      }
      for (var n = 0; n < dependencylist.length; ++n) {
        var path = getfile(dependencylist[n], listOfElements)
        if (path.length > 1) {
          var bowerName = path.split("/")[1]
          var re_repo = new RegExp('([^/]*/'+bowerName+')(?:\.git)','gi')
          var re_ver =  new RegExp('(?:'+bowerName+'/\.bower\.json:"_release": ")([^"]*)','gi'); 
          var found_repo = re_repo.exec(gitList)
          var found_ver = re_ver.exec(gitList)
          
          if (found_repo && found_ver) {
            if (found_ver[1].length < 7) {
              output.dependencies[bowerName] = found_repo[1] + "#~" +found_ver[1]
            } else {
              output.dependencies[bowerName] = found_repo[1] + "#" +found_ver[1]
            }
          } else {
            output.dependencies[bowerName] = "*"
          }
        }
      }
      return JSON.stringify(output, null, '  ')
    },
    _cat: function (a, b, c) {
      return a + b + c
    },
    _getArray: function (s, a) {
      if (s && s !== '' && a === undefined) {
        return s.split(',')  
      } else if (s && s !== '' && Array.isArray(a)){
        return s.split(',').concat(a)
      } else if (Array.isArray(a)) {
        return a
      } else {
        return []
      }
    },
    _getCode: function (head, body) {
      at = 0
      var output = [
        tabs() + '<!doctype html>',
        tabs(1) + '<html>'
      ]
      for (var i = 0; i < head.length; ++i) {
        output.push(tabs() + head[i])
      }
      for (var n = 0; n < body.length; ++n) {
        output.push(tabs() + body[n])
      }
      output.push(tabs(-1) + '</html>')
      return addLine(output)
    },
    _getHead: function (name) {
      if (name !== '') return [
        tabs(1) + '<head>',
        tabs() + '<title>' + name + ' demo</title>',
        tabs() + '<sc' + 'ript src="/bower_components/webcomponentsjs/webcomponents-lite.js"></sc' + 'ript>',
        tabs() + '<link rel="import" href="' + name + '.html">',
        tabs(-1) + '</head>'
      ]
    },
    _getIframeHead: function (base, name) {
      if (name !== '') return [
        tabs(1) +'<head>',
        tabs() + '<base href="' + base + '">',
        tabs() + '<title>' + name + ' demo</title>',
        tabs() + '<sc'+'ript src="/bower_components/webcomponentsjs/webcomponents-lite.js"></sc'+'ript>',
        tabs() + '<sc' + "ript>window.onerror = function (errorMsg, url, line) {document.write('Error: ' + errorMsg + ' Script: ' + url + ' Line: ' + line)}</sc" + 'ript>',
        tabs(-1)+'</head>'
      ]
    },
    _getTests: function (name) {
      if (name !== '') {
        var testStub = addLine([
          tabs() + '<!doctype html>',
          tabs(1) +'<html>',
          tabs(1) +'<head>',
          tabs() + '<meta charset="utf-8">',
          tabs() + '<scr' + 'ipt src="../../webcomponentsjs/webcomponents-lite.js"></scr' + 'ipt>',
          tabs() + '<scri' + 'pt src="../../web-component-tester/browser.js"></scr' + 'ipt>',
          tabs(-1)+'</head>',
          tabs(1) +'<body>',
          tabs(1) +'<scr' + 'ipt>',
          tabs(1) +'WCT.loadSuites([',
          tabs() + "'" + name + ".html',",
          tabs() + "'" + name + ".html?dom=shadow'",
          tabs(-1)+']);',
          tabs(-1)+'</scr' + 'ipt>',
          tabs(-1)+'</body>',
          tabs(-1)+'</html>',
          tabs() + '## /test/' + name + '.html',
          tabs() + '<!doctype html>',
          tabs(1) +'<html>',
          tabs(1) +'<head>',
          tabs() + '<title>' + name + '</title>',
          tabs() + '<sc' + 'ript src="../../webcomponentsjs/webcomponents.js"></scr' + 'ipt>',
          tabs() + '<scr' + 'ipt src="../../web-component-tester/browser.js"></sc' + 'ript>',
          tabs() + '<scr' + 'ipt src="../../test-fixture/test-fixture-mocha.js"></scr' + 'ipt>',
          tabs() + '<scr' + 'ipt src="../../iron-test-helpers/mock-interactions.js"></scr' + 'ipt>',
          tabs() + '<link rel="import" href="../../polymer/polymer.html">',
          tabs() + '<link rel="import" href="../../test-fixture/test-fixture.html">',
          tabs() + '<link rel="import" href="../' + name + '.html">',
          tabs(-1)+'</head>',
          tabs(1) +'<body>',
          tabs(1) +'<test-fixture id="' + toCamelCase(name) + '">',
          tabs(1) +'<template>',
          tabs() + '<' + name + '></' + name + '> //add attributes',
          tabs(-1)+'</template>',
          tabs(-1)+'</test-fixture>',
          tabs(1) +'<scr' + 'ipt>',
          tabs(1) +"suite('<" + name + ">', function () {",
          tabs() + 'var ' + toCamelCase(name) + ';',
          tabs(1) +'setup(function () {',
          tabs() + toCamelCase(name) + " = fixture('" + toCamelCase(name) + "');",
          tabs(-1)+'});',
          tabs(1)+'teardown(function () {',
          tabs() + '//...',
          tabs(-1)+'});',
          tabs(1) +"suite('basic usage', function () {",
          tabs(1) +"test('can be triggered with space', function(done) {",
          tabs(1) +toCamelCase(name) + ".addEventListener('keydown', function() {",
          tabs() + 'done()',
          tabs(-1)+'})',
          tabs() + 'MockInteractions.pressSpace('+toCamelCase(name)+')',
          tabs(-1)+'})',
          tabs(1) +"test('can be clicked', function(done) {",
          tabs(1) +toCamelCase(name) + ".addEventListener('click', function() {",
          tabs() + 'done()',
          tabs(-1)+'})',
          tabs() + 'MockInteractions.tap('+toCamelCase(name)+')',
          tabs(-1)+'})',
          tabs(-1)+'})',
          tabs(-1)+'})',
          tabs(-1)+'</scr' + 'ipt>',
          tabs(-1)+'</body>',
          tabs(-1)+'</html>',
          tabs() + '## .travis.yml',
          tabs() + 'language: node_js',
          tabs() + 'sudo: false',
          tabs() + 'node_js: stable',
          tabs(1) +'addons:',
          tabs() + 'chrome: latest',
          tabs(-1)+'apt:',
          tabs(1) +'sources:',
          tabs() + '- google-chrome',
          tabs() + 'packages:',
          tabs() + '- google-chrome-stable',
          tabs(-1)+'before_script:',
          tabs() + '- npm install web-component-tester',
          tabs() + '- npm install bower',
          tabs() + '- export PATH=$PWD/node_modules/.bin:$PATH',
          tabs() + '- bower install',
          tabs() + 'script:',
          tabs() + '- xvfb-run wct --skip-plugin sauce',
          tabs() + '## wct.conf.json',
          ''
        ])
        return testStub + JSON.stringify({verbose: true, plugins: {local: { browsers: ["chrome"]}}}, null, '  ')
      }
    },
    _getBody: function (name, attrs) {
      if (!attrs) {
        attrs = ""
      }
      var output = [
        tabs(1) +'<body>',
        tabs() + '<h3>' + name + ' Demo</h3>',
        tabs() + '<' + name + ' ' + attrs + '></' + name + '>',
        tabs(-1)+'</body>'
      ]

      if (name !== '') return output
    },
    _getElementCode: function (elementData, dependencylist, listOfElements) {
      var output = []

      output.push('<!--')
      output.push('`<' + elementData.name + '></'+elementData.name+'>` ' + elementData.description)
      output.push('@demo demo.html')
      output.push('-->', '')
      output.push('<dom-module id="' + name + '">')
      output.push('<template>')
      for (var a = 0; a < elementData.html.split('\n').length; ++a) {
        output.push(tabs() + elementData.html.split('\n')[a])
      }
      output.push('</template>')
      output.push('</dom-module>')
      output.push('<sc' + 'ript>')
       
      output.push(tabs(1)+'Polymer({')

      output.push(tabs()+'is: "' + name + '",')
      if (elementData.properties && Object.keys(elementData.properties).length) {
        output.push(tabs(1)+'properties:{')
        for (index in elementData.properties) {
          // todo type / computed / ...
          console.log(elementData.properties[index])
          if (elementData.properties[index].type && Object.keys(elementData.properties[index]).length == 1) {
            output.push(tabs() + index + ":" + elementData.properties[index].type + ",") 
          } else {
            output.push(tabs() + index + ":" + "{") 
            for (prop in elementData.properties[index]) {
              output.push(tabs() + prop + ":" + elementData.properties[index][prop] + ",") 
            }
            output.push(tabs() + "},") 
          }   
        }
        output.push(tabs(-1)+'},')
      }
      for (index in elementData.functions) {
        // todo attr / body / ...
        output.push(tabs() + elementData.functions[index] + ": function(){ return 1},")
      }
      
      
      output.push(tabs(-1)+'})')
     
      output.push('</sc' + 'ript>')

      for (var x = 0; x < dependencylist.length; ++x) {
        output.unshift('<link rel="import" href="' + getfileForIframe(dependencylist[x], listOfElements) + '">')
      }
      return addLine(output)
    },
    _getDescriptor: function (element) {
      //  console.log("_getDescriptor(",element,demo)
      return {
      }
    },
    _getMarkdown: function (demo, element, name, bower, tests) {
      return 'demo.html\n\n ```html \n' + demo + '\n```\n' + name + '.html\n\n```html \n' + element + '\n``` \nbower.json\n ```\n' + bower + '\n``` \ntest/index.html\n ```\n' + tests + '\n```'
    },
    _getCodeiframe: function (iframeDemo, element) {
      return iframeDemo + element
    },
    _getSrc: function (codeiframe) {
      return codeiframe
    },
    _docsSrc: function (docsFor, listOfElements) {
      var path = getfile(docsFor, listOfElements)
      if (path.length > 1) {
        var bowerName = path.split("/")[1]
        return '/bower_components/' + bowerName + '/#' + docsFor;
      }
    },
    _getDomTemplateDependencies: function (domTemplate, dependencies) {
      var re = /(?:<\/)([a-z0-9]*[\-a-z0-9]*-[a-z0-9]*)(?:>)/gi
      var output = []
      var m

      while ((m = re.exec(domTemplate)) !== null) {
        if (dependencies.split(',').indexOf(m[1]) === -1) {
          dependencies = dependencies + ',' + m[1]
          output.push(m[1])
        }
      }

      return output
    }
  })
})()
</script>
