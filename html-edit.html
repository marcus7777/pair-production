<link rel="import" href="../polymer/polymer.html">
<!--
`<html-edit>` Adds helpful buttons to help you edit text.
Takes text and keeps a history
@demo demo.html
-->

<dom-module id="html-edit">
  <template>
    <div>
      <h3>{{label}}</h3>
      <textarea style="width:100%" on-blur="{{updateFilter(this)}}" onkeyup="takekeyup(this)" label="{{label}}" value="{{value::change}}"></textarea>
      <button onclick="closeTag(this)" >close tag</button>
      <select onblur="addTag(this);">
        <option>add tag</option>
        <template is="dom-repeat" items="{{tags}}" filter="_computeFilter">
          <option value="{{item.code}}" title="{{item.move}}">{{item.tag}}</option>
        </template>
      </select>
    </div>
  </template>
</dom-module>
<script>
  function closeTag(e) {
    var closeRe = /<([\w-]*) *(?:[^>]*)\w?>[^<]*$/g;
    var t = e.parentNode.getElementsByTagName('textarea')[0];

    var textBefore = t.value.substring(0, t.selectionStart);
    var textAfter = t.value.substring(t.selectionStart);
    
    var add;
    if ((m = closeRe.exec(textBefore)) !== null) {
      console.log("textBefore match", m[1]);
      if (m[1] !== "") {
        add = "</" + m[1] + ">";
      }
    }
    TextEvent(t, 0, 0, add, add.length);
  }
  function addTag(e) {
    var tag = e.options[e.selectedIndex].value;
    if (tag !== "add tag") {
      var t = e.parentNode.getElementsByTagName('textarea')[0];
      TextEvent(t, 0, 0, tag, e.options[e.selectedIndex].title*1);
    }
  }
  function TextEvent(editor, start, end, text, move) {
    if (start === end) {
      start = editor.selectionStart;
      end = editor.selectionEnd;
    }
    var e = document.createEvent('TextEvent');
    e.initTextEvent('textInput', true, true, null, text, 9, "en-US");
    editor.focus();
    editor.setSelectionRange(start, end);
    editor.dispatchEvent(e);
    var moveTo = (start*1) + move
    editor.setSelectionRange(moveTo, moveTo);
  }
  function takekeyup (e) {
    if (!e.lastValue) {
      if (!e.value) {
        e.lastValue = "";
      } else {
        e.lastValue = e.value;
      }
    }
    var last = e.lastValue,
        current = e.value;

    // Added chars
    if (current.length > last.length) {
      var start = e.selectionStart, added = current.substr(start - 1, 1);
      if (added == "<") {
        TextEvent(e, start - 1, start, '<>', 1);
      } else if (added == '"') {
        TextEvent(e, start - 1, start, '""', 1);   
      } else if (added == "'") {
        TextEvent(e, start - 1, start, "''", 1);
      } else if (added == '{') {
        TextEvent(e, start - 1, start, '{}', 1);
      } else if (added == '[') {
        TextEvent(e, start - 1, start, '[]', 1);
      }
    }
    e.lastValue = e.value;
  };
  Polymer({
    is: "html-edit",
    properties: {
      value: {type:String,notify:true},
      label: String,
      tags: {
        value:[
          {code:"<paper-input label='label' value='{{}}'></paper-input>",tag:"paper-input",move:36},
          {code:"<h1></h1>",tag:"h1",move:4},
          {code:"<h2></h2>",tag:"h2",move:4},
          {code:"<h3></h3>",tag:"h3",move:4},
          {code:"<h4></h4>",tag:"h4",move:4},
          {code:"<h5></h5>",tag:"h5",move:4},
          {code:"<h6></h6>",tag:"h6",move:4},
          {code:"<p></p>",tag:"p",move:3},
          {code:"<i></i>",tag:"i",move:3},
          {code:'<a href=""></a>',tag:"a",move:9},
          {code:"<ul>\n<li></li>\n</ul>",tag:"ul",move:9},
          {code:"<blockquote></blockquote>",tag:"blockquote",move:12},
          {code:"<hr />\n",tag:"hr",move:7},
          {code:'<img src="" />\n',tag:"img",move:10},
          {code:"<div>\n</div>",tag:"div",move:7}
        ]
      }
    },
    updateFilter : function (e) {
      debugger; // fix me
      var re = /<([-\w]*)$/g;
      var t = e.parentNode.getElementsByTagName('textarea')[0];
      var start = t.selectionStart;
      var end = t.selectionEnd;
      if (start === end) {
        var textBefore = t.value.substring(0, start);
    
        var m;
        if ((m = re.exec(textBefore)) !== null) {
          if (m.index === re.lastIndex) {
            re.lastIndex++;
          }
          if (m[1] !== "") {
            this.filter = m[1];
          }
        }
      }
    },
    _computeFilter: function(partOfTag) {
      if (partOfTag && partOfTag ==! "") {
        return function(item) {
          return item.tag.indexOf(partOfTag) !== -1;
        };
      } else {        
        return function(item) {
          return true;
        };
      }
    }
  });
</script>
