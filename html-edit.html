<link rel="import" href="../polymer/polymer.html">
<!--
`<html-edit>` Adds helpful buttons to help you edit text.
Takes text and keeps a history
@demo demo.html
-->

<dom-module id="html-edit">
  <template>
    <div>
      <h3>{{label}}</h3>
      <textarea style="width:100%" onblur="updateFilter(this)" onfocus="textareaOnfocus(this)" onkeyup="this.parentNode.getElementsByTagName('input')[0].value=doGetCaretPosition(this)" label="{{label}}" value="{{value::change}}"></textarea>
      <button onclick="closeTag(this)" >close tag</button>
      <select onblur="addTag(this);">
        <option>add tag</option>
        <template is="dom-repeat" items="{{tags}}" filter="_computeFilter">
          <option value="{{item.code}}" title="{{item.move}}">{{item.tag}}</option>
        </template>
      </select>
      <input style="width:50px" min="0" type="number" onchange="process(this)" />
    </div>
  </template>
</dom-module>
<script>
  var filter = "";
  function doGetCaretPosition (ctrl) {
    var CaretPos = 0;
    if (ctrl.selectionStart || ctrl.selectionStart == '0') {
      CaretPos = ctrl.selectionStart;
    }
    return (CaretPos);
  }
  function setCaretPosition(ctrl, pos) {
    no = pos
    if(ctrl.setSelectionRange){
      ctrl.focus();
      ctrl.setSelectionRange(pos,pos);
    } else if (ctrl.createTextRange) {
      var range = ctrl.createTextRange();
      range.collapse(true);
      range.moveEnd('character', pos);
      range.moveStart('character', pos);
      range.select();
    }
  }
  function process(e) {
    var t = e.parentNode.getElementsByTagName('textarea');
    var v = e.parentNode.getElementsByTagName('input');
    setCaretPosition(t[0],v[0].value);
    updateFilter(t[0]);
  }
  function textareaOnfocus(e) {
    var that=e;
    var pos=e.parentNode.getElementsByTagName('input')[0].value;
    setTimeout(function(){if (doGetCaretPosition(that) === 0) setCaretPosition(that, pos)}, 100);
  }
  function closeTag(e) {
    var closeRe = /<([\w-]*) *(?:[^>]*)\w?>[^<]*$/g;
    var t = e.parentNode.getElementsByTagName('textarea')[0];
    var v = e.parentNode.getElementsByTagName('input')[0];

    var textBefore = t.value.substring(0, v.value);
    var textAfter = t.value.substring(v.value);

    if ((m = closeRe.exec(textBefore)) !== null) {
      console.log("textBefore match", m[1]);
      if (m[1] !== "") {
        var add = "</" + m[1] + ">"
        t.value = textBefore + add + textAfter;
        v.value = +(v.value) + add.length;
      }
    }
    process(e);
  }
  function addTag(e) {
    var tag = e.options[e.selectedIndex].value;
    if (tag !== "add tag") {
      var t = e.parentNode.getElementsByTagName('textarea')[0];
      var v = e.parentNode.getElementsByTagName('input')[0];
      
      TextEvent(t, v.value, v.value, tag, e.options[e.selectedIndex].title*1)
      process(e);
    }
  }
  function TextEvent(editor, start, end, text, move) {
    var e = document.createEvent('TextEvent');
    e.initTextEvent('textInput', true, true, null, text, 9, "en-US");
    editor.focus();
    editor.setSelectionRange(start, end);
    editor.dispatchEvent(e);
    var moveTo = start + move
    editor.setSelectionRange(moveTo, moveTo);
  }
  function updateFilter(e) {
    var v = e.parentNode.getElementsByTagName('input')[0];
    if (+(v.value) !== 0) {
      var re = /<([-\w]*)$/g;
      var t = e.parentNode.getElementsByTagName('textarea')[0];
      var textBefore = t.value.substring(0, v.value);
      var m;
      if ((m = re.exec(textBefore)) !== null) {
        if (m.index === re.lastIndex) {
          re.lastIndex++;
        }
        if (m[1] !== "") {
          filter = m[1];
        }
      }
    }
  }
  Polymer({
    is: "html-edit",
    properties: {
      value: {type:String,notify:true},
      label: String,
      tags: {value:[
        {code:"<paper-input label='label' value='{{}}'></paper-input>",tag:"paper-input",move:36},
        {code:"<h1></h1>",tag:"h1",move:4},
        {code:"<h2></h2>",tag:"h2",move:4},
        {code:"<h3></h3>",tag:"h3",move:4},
        {code:"<h4></h4>",tag:"h4",move:4},
        {code:"<h5></h5>",tag:"h5",move:4},
        {code:"<h6></h6>",tag:"h6",move:4},
        {code:"<p></p>",tag:"p",move:3},
        {code:"<i></i>",tag:"i",move:3},
        {code:'<a href=""></a>',tag:"a",move:9},
        {code:"<ul>\n<li></li>\n</ul>",tag:"ul",move:9},
        {code:"<blockquote></blockquote>",tag:"blockquote",move:12},
        {code:"<hr />\n",tag:"hr",move:7},
        {code:'<img src="" />\n',tag:"img",move:10},
        {code:"<div>\n</div>",tag:"div",move:7}
        ]
      },
      filterElements: function() {
        debugger;
      }
    },
    _computeFilter: function(partOfTag) {
      if (partOfTag && partOfTag ==! "") {
        return function(item) {
          return item.tag.indexOf(partOfTag) !== -1;
        };
      } else {        
        return function(item) {
          return true;
        };
      }
    }
  });
</script>
