<link rel="import" href="../vellum-chip/vellum-chip.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog-scrollable/paper-dialog-scrollable.html">

<!--
`<variables-input>` 
-->

<dom-module id="variables-input">
  <template>
    <template is="dom-repeat" items="{{asArray}}">
      <vellum-chip elevation="1" title="Load {{getKey(index)}}" value="{{getKey(index)}}" on-tap="edit" index="[[index]]">{{getKey(index)}}</vellum-chip>
    </template><br />
    <paper-dialog id="edit">
      <h2>Update {{_editing.name}}</h2>
      <paper-dialog-scrollable>
        <input-save value="{{_editing.type}}" options-input></input-save>
        <input-save value="{{_editing.value}}" label$="default for {{_editing.name}}" pattern$="{{getRepType(_editing.type)}}" auto-validate error-message="needs to be a {{_editing.type}} so {{repType}}"></input-save>
        <input-save value="{{_editing.computed}}" label$="{{_editing.name}} is computed by" auto-validate pattern="{{reFunctionsAndVariables}}" error-message="needs to a function ({{functions}}) with input(s)"></input-save>
        <input-save value="{{_editing.observer}}" label="observer by" auto-validate pattern="{{reFunctions}}" error-message="needs to a function ( {{functions}} ) add to \'functions'\' if needed)"></input-save>
      </paper-dialog-scrollable>
      <div class="buttons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm autofocus on-tap="save">Accept</paper-button>
      </div>
    </paper-dialog>
    <paper-input value="{{addMe}}" style="width:200px;display:inline-block"></paper-input> <paper-button on-tap="add">Add</paper-button>
  </template>
</dom-module> 
<script>
    Polymer({
      is: 'variables-input',
      properties:{
        functions:{type:String},
        reFunctions: {computed:"getReFunctions(functions)"},
        reFunctionsAndVariables: {computed:"getReFunctionsAndVariables(reFunctions)"},
        value:{notify:true,value:{}},
        asArray:{computed:"getAsArray(value.*)"},
        _editing:{value:{}},
        _editingIndex:Number,
        ___:{computed:"updateValue(asArray.*)"}:w

      },
      getKey: function(i) {
        return Object.keys(this.value)[i]
      },
      updateValue: function(e) {
       // var theKeys = Object.keys(this.value)
       // for (index in e.base) {
       //   this.set("value." + theKeys[index], e.base[index])
       // }
      },
      add: function(){
        if (this.addMe) {
          this.addMe = this.addMe.trim()
          if (Polymer.Base.hasOwnProperty(this.addMe)) {
            alert(this.addMe + " is taken (by Polymer.Base)")
          } else if (this.functions.hasOwnProperty(this.addMe)) {
            alert(this.addMe + " is taken (by a method/function)")
          } else if (this.value.hasOwnProperty(this.addMe)) {
            alert(this.addMe + " is taken")
          } else {
            if (!this.value || !((typeof this.value === "object") && (this.value !== null))) {
              this.value = {}
            }
            this.set("value."+ this.addMe,{})
          }
        }
      },
      getAsArray: function(Obj) {
        if (Obj.base) {
          theArray = []
          for (key in Obj.base) {
            theArray.push(Obj.base[key])
          }
          return theArray
        }
      },
      getArray:  function(s) {
        if (s !== "") return toCamelCase(s).split(',');
      },
      edit: function(e) {
        this._editingIndex = +e.currentTarget.index
        this.set("_editing", this.asArray[+e.currentTarget.index])
        this.set("_editing.name", this.getKey(+e.currentTarget.index))
        this.$.edit.open()
      },
      save: function() {
          debugger
        
      },
      getRepType: function(t) {
        switch(t) {
           // TODO Symbol Functions
          case 'Null': return 'null';break;
          case 'Array': return '^\\[.*\\]$';break;
          case 'Boolean': return '(true|false)';break;
          case 'Number': return '^[0-9\.]*$';break;
          case 'Object': return '^\{.*\}$';break;
          case 'String': return '^\".*\"$';break;
          default: return '';break;
        }
      },
      getReFunctions: function(functions){return '(' + functions.replace(/,/g, '|') + ')';},
      getReFunctionsAndVariables: function(reFunctions) {return reFunctions+'\\([a-zA-Z]*[a-zA-Z\,]*[a-zA-Z]+\\)'}
    });
</script>
