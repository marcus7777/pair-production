<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../vellum-chip/vellum-chip.html">
<!--
`<variables-input>` 
-->

<dom-module id="variables-input">
  <template>
    <template is="dom-repeat" items="{{asArray}}">
      <vellum-chip elevation="1" title="Load {{getKey(index)}}" value="{{getKey(index)}}" on-tap="edit" index="[[index]]">{{getKey(index)}}</vellum-chip>
    </template><br />
    <!--TODO rewrite as edit dialog
    <template is="dom-repeat" items="{{asArray}}">
      <div style="padding:20px"> <h4>{{getKey(index)}}</h4>
        <input-save value="{{item.type}}" options-input></input-save>
        <input-save value="{{item.value}}" label$="default for {{getKey(index)}}" pattern$="{{getRepType(item.type)}}" auto-validate error-message="needs to be a {{type}} so {{repType}}"></input-save>
        <input-save value="{{item.computed}}" label$="{{getKey(index)}} is computed by" auto-validate pattern="{{reFunctionsAndVariables}}" error-message="needs to a function ({{functions}}) with input(s)"></input-save>
        <input-save value="{{item.observer}}" label$="observer {{getKey(index)}}" auto-validate pattern="{{reFunctions}}" error-message="needs to a function ( {{functions}} ) add to \'functions'\' if needed)"></input-save>
      </div>
    </template> -->
    <paper-input value="{{addMe}}" style="width:200px;display:inline-block"></paper-input> <paper-button on-tap="add">Add</paper-button>
  </template>
</dom-module> 
<script>
    Polymer({
      is: 'variables-input',
      properties:{
        functions:{type:String},
        reFunctions: {computed:"getReFunctions(functions)"},
        reFunctionsAndVariables: {computed:"getReFunctionsAndVariables(reFunctions)"},
        value:{notify:true,value:{}},
        asArray:{computed:"getAsArray(value.*)"},
        ___:{computed:"updateValue(asArray.*)"}
      },
      getKey: function(i) {
        return Object.keys(this.value)[i]
      },
      updateValue: function(e) {
        var theKeys = Object.keys(this.value)
        for (index in e.base) {
          this.set("value." + theKeys[index], e.base[index])
        }
      },
      add: function(){
        if (this.addMe) {
          this.addMe = this.addMe.trim()
          if (Polymer.Base.hasOwnProperty(this.addMe)) {
            alert(this.addMe + " is taken (by Polymer.Base)")
          } else {
            if (!this.value || !((typeof this.value === "object") && (this.value !== null))) {
              this.value = {}
            }
            this.set("value."+ this.addMe,{})
          }
        }
      },
      getAsArray: function(Obj) {
        if (Obj.base) {
          debugger
          theArray = []
          for (key in Obj.base) {
            theArray.push(Obj.base[key])
          }
          return theArray
        }
      },
      getArray:  function(s) {
        if (s !== "") return toCamelCase(s).split(',');
      },
      edit: function(e) {
        //show dialog
        debugger
      },
      getRepType: function(t) {
        switch(t) {
           // TODO Symbol Functions
          case 'Null': return 'null';break;
          case 'Array': return '^\\[.*\\]$';break;
          case 'Boolean': return '(true|false)';break;
          case 'Number': return '^[0-9\.]*$';break;
          case 'Object': return '^\{.*\}$';break;
          case 'String': return '^\".*\"$';break;
          default: return '';break;
        }
      },
      getReFunctions: function(functions){return '(' + functions.replace(/,/g, '|') + ')';},
      getReFunctionsAndVariables: function(reFunctions) {return reFunctions+'\\([a-zA-Z]*[a-zA-Z\,]*[a-zA-Z]+\\)'}
    });
</script>
