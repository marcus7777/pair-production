<link rel="import" href="../juicy-ace-editor/juicy-ace-editor.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-input/paper-textarea.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">
<!--
`<input-save>`  
-->
<dom-module id="input-save">
  <template>
    <template is="dom-if" if="{{text}}">
      <paper-input label="{{label}}" value="{{value}}" pattern="{{pattern}}" error-message="{{errorMessage}}" auto-validate="{{autoValidate}}"></paper-input>
    </template>
    <template is="dom-if" if="{{textarea}}">
      <paper-textarea label="{{label}}" value="{{value}}" pattern="{{pattern}}" error-message="{{errorMessage}}" auto-validate="{{autoValidate}}"></paper-textarea>
    </template> 
    <template is="dom-if" if="{{type}}">
      <select value="{{value::input}}">
        <template is="dom-repeat" items="[[options]]">
          <option value="[[item]]">[[item]]</option>
        </template>
      </select>
    </template>
    <template if="{{code}}>">
      <juicy-ace-editor theme="ace/theme/monokai" mode="ace/mode/html">{{value}}</juicy-ace-editor>
    </template> 
    <iron-localstorage on-iron-localstorage-load-empty="initializeDefault" name="pair-production" value="{{data}}"></iron-localstorage>
  </template>
</dom-module>
<script>
  
  Polymer({
    is: 'input-save',
    properties: {
      name: String,
      path: String,
      options: {
        type: Array,
        value : ["Null", "Array", "Boolean", "Number", "Object", "String", "Symbol", "Function"]
      },
      text: {type:Boolean,computed:"isText(textarea,type)"},
      code: {type:Boolean,computed:"isText(textarea,type)"},
      changed: {type:Boolean,notify:true,value:false},
      textarea: {type:Boolean,value:false},
      type: {type:Boolean,value:false},
      label: String,
      pattern: String,
      autoValidate: Boolean,
      errorMessage: String,
      value: {type:String,notify:true},
      data: {type:Object,observer:"dataChanged"},
      element: { // move to observers
        computed:'saveThis(path,value)'
      }
    },
    isText: function(textarea,type){
      return !textarea && !type;
    },
    initializeDefault: function(ev){
      this.loaded = true;
      this.data = js_data;
    },
    saveThis:  function(path,value) {
      js_data[path] = value;
      this.debounce('save', function() {
        if (this.loaded === true) {
          if (this.data === undefined || this.data === null) {
            this.data = {};
          }
          if (this.data[path] !== js_data[path]) {
            this.data = clone(js_data);
            this.changed = !this.changed ;
          }
        }
      }, 3000);
      return js_data;
    },
    dataChanged: function(loading_data) {
      if (loading_data !== undefined || loading_data !== null){ 
        if (loading_data.hasOwnProperty(this.path) && this.value !== loading_data[this.path]) {
          this.value = loading_data[this.path];
        }
      }
      this.loaded = true;
    }
  });
 function clone(obj) {
    var copy;
    // Handle the 3 simple types, and null or undefined
    if (null == obj || "object" != typeof obj) return obj;
    // Handle Date
    if (obj instanceof Date) {
      copy = new Date();
      copy.setTime(obj.getTime());
      return copy;
    }
    // Handle Array
    if (obj instanceof Array) {
      copy = [];
      for (var i = 0, len = obj.length; i < len; i++) {
        copy[i] = clone(obj[i]);
      }
      return copy;
    }
    // Handle Object
    if (obj instanceof Object) {
      copy = {};
      for (var attr in obj) {
        if (obj.hasOwnProperty(attr)) copy[attr] = clone(obj[attr]);
      }
      return copy;
    }
    throw new Error("Unable to copy obj! Its type isn't supported.");
  }
  var js_data = {};
</script>
